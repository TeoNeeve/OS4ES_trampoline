IMPLEMENTATION stm32l432 {
  DEVICE_KIND [] {
    STRUCT {
      UINT32 OFFSET;
      ENUM [ BYTE, HALFWORD, WORD, DOUBLEWORD ] SIZE;
      STRUCT {
        UINT32 LOC;
      } BIT [];
      STRUCT {
        UINT32 START;
        UINT32 STOP;
      } FIELD [];
    } REGISTER [];
    STRUCT {
      IDENTIFIER ENABLE [];
      BOOLEAN ACK = FALSE;
    } EVENT [];
  };
  
  DEVICE [] {
    DEVICE_KIND_TYPE KIND;
    UINT32 ADDRESS;
    INTERRUPT_TYPE VECTOR;
  };

  OS {
    BOOLEAN [
      TRUE {
        ENUM [
          serial {
            UINT32 RXBUFFER = 32;
            UINT32 TXBUFFER = 16;
          },
          cmsisdsp
        ] LIBRARY[];
      },
      FALSE
    ] BUILD = FALSE;

    /* trace */
    BOOLEAN [
      TRUE {
        ENUM [
          serial
        ] FORMAT = serial;
      },
      FALSE
    ] TRACE = FALSE;
  };
};

CPU stm32l432 {
  OS features {
    ISR2_PRIORITY_MASKING = TRUE;
  };

  CORTEX stm32fl432 {
    PRIO_BITS = 4;    // used in tpl_cortex_definitions for NVIC config
    CLOCK = 40000000; // init freq with no external oscillator...
  };

  BUILDOPTIONS buildOptions {
     COMMONFLAGS = "-DSTM32L432xx"; //processor def
  };

  INTERRUPT_COUNT nb_it {
    IT_TABLE_SIZE = 77; //61 STM32 interrupts + 16 ARM related interrupts.
  };
  
  #include "interruptDefs.oil"

  PLATFORM_FILES stm32l432 {
    PATH = "cortex-m/armv7em/stm32l432";
    CFILE = "handlers_stm32l432.c";
    CFILE = "startup_stm32l432.c";
    CFILE = "system_stm32l4xx.c";
    CFILE = "tpl_machine_stm32l432.c";
    CFILE = "tpl_memory_protection.c";
  };

  PLATFORM_FILES stm32l432_trace {
    PATH = "cortex-m/armv7em/stm32f303";
	CFILE = "tpl_trace.c";
  };

  PLATFORM_FILES stm32fl432_cmsis {
    PATH = "cortex-m/armv7em/stm32l432/CMSIS-ST/Device/ST/STM32L4xx/Include";
  };

PLATFORM_FILES cmsis_dsp_inc {
    PATH    = "cortex-m/CMSIS-DSP/Include";
  };
  
  PLATFORM_FILES cmsis_dsp_dsp_inc {
    PATH    = "cortex-m/CMSIS-DSP/Include/dsp";
  };
   
 PLATFORM_FILES cmsis_dsp_private_inc {
    PATH    = "cortex-m/CMSIS-DSP/PrivateInclude";
  };
  
 LIBRARY cmsisdsp {
   PATH = "cortex-m/CMSIS-DSP";
  //  CHEADER = "serial.h";
   CFILE = "Source/MatrixFunctions/MatrixFunctionsF16.c";
   CFILE = "Source/MatrixFunctions/MatrixFunctions.c";
//   CFILE = "Source/MatrixFunctions/_arm_mat_mult_neon.c";
   CFILE = "Source/TransformFunctions/TransformFunctions.c";
   CFILE = "Source/TransformFunctions/TransformFunctionsF16.c";
   CFILE = "Source/CommonTables/CommonTablesF16.c";
   CFILE = "Source/CommonTables/CommonTables.c";
   CFILE = "Source/FilteringFunctions/FilteringFunctionsF16.c";
   CFILE = "Source/FilteringFunctions/FilteringFunctions.c";
   CFILE = "Source/StatisticsFunctions/StatisticsFunctionsF16.c";
   CFILE = "Source/StatisticsFunctions/StatisticsFunctions.c";
   CFILE = "Source/BasicMathFunctions/BasicMathFunctions.c";
   CFILE = "Source/BasicMathFunctions/BasicMathFunctionsF16.c";
   CFILE = "Source/InterpolationFunctions/InterpolationFunctions.c";
   CFILE = "Source/InterpolationFunctions/InterpolationFunctionsF16.c";
   CFILE = "Source/SupportFunctions/SupportFunctionsF16.c";
   CFILE = "Source/SupportFunctions/SupportFunctions.c";
   CFILE = "Source/DistanceFunctions/DistanceFunctions.c";
   CFILE = "Source/DistanceFunctions/DistanceFunctionsF16.c";
   CFILE = "Source/ControllerFunctions/ControllerFunctions.c";
   CFILE = "Source/FastMathFunctions/FastMathFunctions.c";
   CFILE = "Source/FastMathFunctions/FastMathFunctionsF16.c";
   CFILE = "Source/WindowFunctions/WindowFunctions.c";
   CFILE = "Source/BayesFunctions/BayesFunctionsF16.c";
   CFILE = "Source/BayesFunctions/BayesFunctions.c";
   CFILE = "Source/SVMFunctions/SVMFunctions.c";
   CFILE = "Source/SVMFunctions/SVMFunctionsF16.c";
   CFILE = "Source/QuaternionMathFunctions/QuaternionMathFunctions.c";
   CFILE = "Source/ComplexMathFunctions/ComplexMathFunctions.c";
   CFILE = "Source/ComplexMathFunctions/ComplexMathFunctionsF16.c";
 };
 
 
 PLATFORM_FILES cmsis_nn_inc {
    PATH    = "cortex-m/CMSIS-NN/Include";
  };
  
 PLATFORM_FILES cmsis_dsp_private_inc {
    PATH    = "cortex-m/CMSIS-DSP/PrivateInclude";
  };

  PLATFORM_FILES stm32l432IO {
    PATH    = "cortex-m/armv7em/stm32l432/lib";
    CFILE   = "pinAccess.c";
  };

  LIBRARY serial {
    PATH = "cortex-m/armv7em/stm32l432/lib";
	  CHEADER = "serial.h";
	  CFILE   = "serial.c";
  };

  POSTBUILD all {
    COMMAND buildbin {
      TYPE = COPIER;
      INPUT = TARGET;
      OUTPUT = ".bin";
      PREOPTION = "-O binary";
    };
  };

  POSTCOMMAND burn {
    COMMAND flash {
      MESSAGE = "Flashing";
      COMMAND = "st-flash";
      INPUT = TARGET { EXT = ".bin"; };
      PREOPTION = "write";
      POSTOPTION = "0x8000000";
    };
  };
};
